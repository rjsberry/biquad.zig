<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>biquad.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAPNJREFUeNpi/P//PwMlgOXHUjly9E0G4hwgZmQiQZMqEK8H4v9QzUEgQSaoADK+zhH9iAGL+C0gDoAaNg9mGLoLfgA1awK9hS9gzgJxA9RQBmQDrgMxJzRMGKE4HYj/Ial5A8QmQLwCJoBsgBYW2+TR1ChDaWt4LOBxKsi/VUh8XiD+gq4IVyzwQAMJBoKwacZlAB8Qf0bi96IZhtOAe1D6LpqaEiz6rmEzQAeIzwGxCJpieFqApo/vQKyJboAaEBsAsSEupwI1MwKjGBTVHOhegMX5UajYRqiBjMgYmj400cVh0XgTiKdC0zhJgJHS7AwQYABm9EAdCKrEfAAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">// The contents of this file is dual-licensed under the MIT or 0BSD license.</span>
</span>
<span class="line" id="L2"></span>
<span class="line" id="L3"><span class="tok-comment">//! Biquad (second order IIR) filters.</span></span>
<span class="line" id="L4"><span class="tok-comment">//!</span></span>
<span class="line" id="L5"><span class="tok-comment">//! `Biquad` works with any floating-point type `T`. You will also need to pick</span></span>
<span class="line" id="L6"><span class="tok-comment">//! a section `S`:</span></span>
<span class="line" id="L7"><span class="tok-comment">//!</span></span>
<span class="line" id="L8"><span class="tok-comment">//! * `DirectFormI` -- Stable to online coefficient recalculation but the most</span></span>
<span class="line" id="L9"><span class="tok-comment">//!   computationally expensive. You can safely update the cutoff frequency of</span></span>
<span class="line" id="L10"><span class="tok-comment">//!   the filter at runtime.</span></span>
<span class="line" id="L11"><span class="tok-comment">//!</span></span>
<span class="line" id="L12"><span class="tok-comment">//! * `DirectFormII` -- Computationally simpler than `DirectFormI` but may be</span></span>
<span class="line" id="L13"><span class="tok-comment">//!   susceptible to overflow for large input values as gain is generally</span></span>
<span class="line" id="L14"><span class="tok-comment">//!   applied before attenuation.</span></span>
<span class="line" id="L15"><span class="tok-comment">//!</span></span>
<span class="line" id="L16"><span class="tok-comment">//! * `TransposedDirectFormII` -- May produce some anomalies when retuned</span></span>
<span class="line" id="L17"><span class="tok-comment">//!   online but is computationally efficient and numerically &quot;robust&quot;. This</span></span>
<span class="line" id="L18"><span class="tok-comment">//!   robustness comes from fact that attenuation of the input signal often</span></span>
<span class="line" id="L19"><span class="tok-comment">//!   occurs before gain.</span></span>
<span class="line" id="L20"><span class="tok-comment">//!</span></span>
<span class="line" id="L21"><span class="tok-comment">//! # Examples</span></span>
<span class="line" id="L22"><span class="tok-comment">//!</span></span>
<span class="line" id="L23"><span class="tok-comment">//!```zig</span></span>
<span class="line" id="L24"><span class="tok-comment">//! const biquad = @import(&quot;biquad.zig&quot;);</span></span>
<span class="line" id="L25"><span class="tok-comment">//!</span></span>
<span class="line" id="L26"><span class="tok-comment">//! const Biquad = biquad.Biquad;</span></span>
<span class="line" id="L27"><span class="tok-comment">//! const Coefficients = biquad.Coefficients;</span></span>
<span class="line" id="L28"><span class="tok-comment">//! const DirectFormI = biquad.DirectFormI;</span></span>
<span class="line" id="L29"><span class="tok-comment">//!</span></span>
<span class="line" id="L30"><span class="tok-comment">//! const coeffs = Coefficients(f32).lowpass(.{</span></span>
<span class="line" id="L31"><span class="tok-comment">//!     .fs = 32_000, // sampling frequency (hz)</span></span>
<span class="line" id="L32"><span class="tok-comment">//!     .f0 = 200, // cutoff frequency (hz)</span></span>
<span class="line" id="L33"><span class="tok-comment">//!     .q = 0.707107 // quality factor, defaults to 1/sqrt(2)</span></span>
<span class="line" id="L34"><span class="tok-comment">//! });</span></span>
<span class="line" id="L35"><span class="tok-comment">//!</span></span>
<span class="line" id="L36"><span class="tok-comment">//! var filter = Biquad(f32, DirectFormI).init(coeffs);</span></span>
<span class="line" id="L37"><span class="tok-comment">//!</span></span>
<span class="line" id="L38"><span class="tok-comment">//! const y = filter.filter(x); // filter an f32 value through the biquad</span></span>
<span class="line" id="L39"><span class="tok-comment">//! ```</span></span>
<span class="line" id="L40"></span>
<span class="line" id="L41"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L42"></span>
<span class="line" id="L43"><span class="tok-kw">const</span> debug = std.debug;</span>
<span class="line" id="L44"><span class="tok-kw">const</span> fmt = std.fmt;</span>
<span class="line" id="L45"><span class="tok-kw">const</span> math = std.math;</span>
<span class="line" id="L46"><span class="tok-kw">const</span> mem = std.mem;</span>
<span class="line" id="L47"></span>
<span class="line" id="L48"><span class="tok-comment">/// Biquad -- a second order IIR filter.</span></span>
<span class="line" id="L49"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Biquad</span>(</span>
<span class="line" id="L50">    <span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>,</span>
<span class="line" id="L51">    <span class="tok-kw">comptime</span> S: *<span class="tok-kw">const</span> <span class="tok-kw">fn</span> (<span class="tok-kw">comptime</span> <span class="tok-type">type</span>) <span class="tok-type">type</span>,</span>
<span class="line" id="L52">) <span class="tok-type">type</span> {</span>
<span class="line" id="L53">    <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L54">        assertFloat(T);</span>
<span class="line" id="L55">        <span class="tok-kw">switch</span> (S) {</span>
<span class="line" id="L56">            DirectFormI, DirectFormII, TransposedDirectFormII =&gt; {},</span>
<span class="line" id="L57">            <span class="tok-kw">else</span> =&gt; {</span>
<span class="line" id="L58">                <span class="tok-builtin">@compileError</span>(fmt.comptimePrint(</span>
<span class="line" id="L59">                    <span class="tok-str">&quot;type `{}` is not a valid biquad section&quot;</span>,</span>
<span class="line" id="L60">                    .{<span class="tok-builtin">@typeName</span>(S)},</span>
<span class="line" id="L61">                ));</span>
<span class="line" id="L62">            },</span>
<span class="line" id="L63">        }</span>
<span class="line" id="L64">    }</span>
<span class="line" id="L65"></span>
<span class="line" id="L66">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L67">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L68"></span>
<span class="line" id="L69">        coeffs: Coefficients(T),</span>
<span class="line" id="L70">        section: S(T),</span>
<span class="line" id="L71"></span>
<span class="line" id="L72">        <span class="tok-comment">/// Initializes the biquad with the given coefficients.</span></span>
<span class="line" id="L73">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(coeffs: Coefficients(T)) Self {</span>
<span class="line" id="L74">            <span class="tok-kw">return</span> Self{</span>
<span class="line" id="L75">                .coeffs = coeffs,</span>
<span class="line" id="L76">                .section = mem.zeroInit(S(T), .{}),</span>
<span class="line" id="L77">            };</span>
<span class="line" id="L78">        }</span>
<span class="line" id="L79"></span>
<span class="line" id="L80">        <span class="tok-comment">/// Filters a value through the biquad.</span></span>
<span class="line" id="L81">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">filter</span>(self: *Self, x: T) T {</span>
<span class="line" id="L82">            <span class="tok-kw">return</span> self.section.filter(x, &amp;self.coeffs);</span>
<span class="line" id="L83">        }</span>
<span class="line" id="L84">    };</span>
<span class="line" id="L85">}</span>
<span class="line" id="L86"></span>
<span class="line" id="L87"><span class="tok-comment">/// The coefficients inside every biquad.</span></span>
<span class="line" id="L88"><span class="tok-comment">///</span></span>
<span class="line" id="L89"><span class="tok-comment">/// Normalized such that in the Z-domain:</span></span>
<span class="line" id="L90"><span class="tok-comment">///</span></span>
<span class="line" id="L91"><span class="tok-comment">/// ```text</span></span>
<span class="line" id="L92"><span class="tok-comment">/// H(z) = (b0 + b1*z^-1 + b2*z^-2) / (1 + a1*z^-1 + a2*z^-2)</span></span>
<span class="line" id="L93"><span class="tok-comment">/// ```</span></span>
<span class="line" id="L94"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Coefficients</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L95">    <span class="tok-kw">comptime</span> assertFloat(T);</span>
<span class="line" id="L96"></span>
<span class="line" id="L97">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L98">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L99"></span>
<span class="line" id="L100">        b0: T,</span>
<span class="line" id="L101">        b1: T,</span>
<span class="line" id="L102">        b2: T,</span>
<span class="line" id="L103">        a1: T,</span>
<span class="line" id="L104">        a2: T,</span>
<span class="line" id="L105"></span>
<span class="line" id="L106">        <span class="tok-comment">/// Calculates the coefficients for a two-pole low-pass filter.</span></span>
<span class="line" id="L107">        <span class="tok-comment">///</span></span>
<span class="line" id="L108">        <span class="tok-comment">/// * `fs` -- sampling frequency (Hz)</span></span>
<span class="line" id="L109">        <span class="tok-comment">/// * `f0` -- cutoff frequency (Hz)</span></span>
<span class="line" id="L110">        <span class="tok-comment">/// * `q` -- quality factor</span></span>
<span class="line" id="L111">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">lowpass</span>(args: <span class="tok-kw">struct</span> {</span>
<span class="line" id="L112">            fs: T,</span>
<span class="line" id="L113">            f0: T,</span>
<span class="line" id="L114">            q: T = math.sqrt1_2,</span>
<span class="line" id="L115">        }) Self {</span>
<span class="line" id="L116">            debug.assert(args.f0 &lt; (<span class="tok-number">2.0</span> * args.fs));</span>
<span class="line" id="L117">            debug.assert(args.q &gt;= <span class="tok-number">0.0</span>);</span>
<span class="line" id="L118"></span>
<span class="line" id="L119">            <span class="tok-kw">const</span> omega = <span class="tok-number">2.0</span> * math.pi * (args.f0 / args.fs);</span>
<span class="line" id="L120">            <span class="tok-kw">const</span> omega_s = math.sin(omega);</span>
<span class="line" id="L121">            <span class="tok-kw">const</span> omega_c = math.cos(omega);</span>
<span class="line" id="L122">            <span class="tok-kw">const</span> alpha = omega_s / (<span class="tok-number">2.0</span> * args.q);</span>
<span class="line" id="L123"></span>
<span class="line" id="L124">            <span class="tok-kw">const</span> a0 = <span class="tok-number">1.0</span> + alpha;</span>
<span class="line" id="L125"></span>
<span class="line" id="L126">            <span class="tok-kw">var</span> self: Self = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L127">            self.a1 = (-<span class="tok-number">2.0</span> * omega_c) / a0;</span>
<span class="line" id="L128">            self.a2 = (<span class="tok-number">1.0</span> - alpha) / a0;</span>
<span class="line" id="L129">            self.b0 = ((<span class="tok-number">1.0</span> - omega_c) * <span class="tok-number">0.5</span>) / a0;</span>
<span class="line" id="L130">            self.b1 = (<span class="tok-number">1.0</span> - omega_c) / a0;</span>
<span class="line" id="L131">            self.b2 = ((<span class="tok-number">1.0</span> - omega_c) * <span class="tok-number">0.5</span>) / a0;</span>
<span class="line" id="L132">            <span class="tok-kw">return</span> self;</span>
<span class="line" id="L133">        }</span>
<span class="line" id="L134">    };</span>
<span class="line" id="L135">}</span>
<span class="line" id="L136"></span>
<span class="line" id="L137"><span class="tok-comment">/// The direct form I biquad realization.</span></span>
<span class="line" id="L138"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">DirectFormI</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L139">    <span class="tok-kw">comptime</span> assertFloat(T);</span>
<span class="line" id="L140"></span>
<span class="line" id="L141">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L142">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L143"></span>
<span class="line" id="L144">        x1: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L145">        x2: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L146">        y1: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L147">        y2: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L148"></span>
<span class="line" id="L149">        <span class="tok-comment">/// Filters a value through the section.</span></span>
<span class="line" id="L150">        <span class="tok-kw">fn</span> <span class="tok-fn">filter</span>(self: *Self, x: T, coeffs: *<span class="tok-kw">const</span> Coefficients(T)) T {</span>
<span class="line" id="L151">            <span class="tok-kw">const</span> y = coeffs.b0 * x +</span>
<span class="line" id="L152">                coeffs.b1 * self.x1 +</span>
<span class="line" id="L153">                coeffs.b2 * self.x2 -</span>
<span class="line" id="L154">                coeffs.a1 * self.y1 -</span>
<span class="line" id="L155">                coeffs.a2 * self.y2;</span>
<span class="line" id="L156"></span>
<span class="line" id="L157">            self.x2 = self.x1;</span>
<span class="line" id="L158">            self.y2 = self.y1;</span>
<span class="line" id="L159">            self.x1 = x;</span>
<span class="line" id="L160">            self.y1 = y;</span>
<span class="line" id="L161"></span>
<span class="line" id="L162">            <span class="tok-kw">return</span> y;</span>
<span class="line" id="L163">        }</span>
<span class="line" id="L164">    };</span>
<span class="line" id="L165">}</span>
<span class="line" id="L166"></span>
<span class="line" id="L167"><span class="tok-comment">/// The direct form II biquad realization.</span></span>
<span class="line" id="L168"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">DirectFormII</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L169">    <span class="tok-kw">comptime</span> assertFloat(T);</span>
<span class="line" id="L170"></span>
<span class="line" id="L171">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L172">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L173"></span>
<span class="line" id="L174">        v1: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L175">        v2: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L176"></span>
<span class="line" id="L177">        <span class="tok-comment">/// Filters a value through the section.</span></span>
<span class="line" id="L178">        <span class="tok-kw">fn</span> <span class="tok-fn">filter</span>(self: *Self, x: T, coeffs: *<span class="tok-kw">const</span> Coefficients(T)) T {</span>
<span class="line" id="L179">            <span class="tok-kw">const</span> w = x - coeffs.a1 * self.v1 - coeffs.a2 * self.v2;</span>
<span class="line" id="L180">            <span class="tok-kw">const</span> y = coeffs.b0 * w + coeffs.b1 * self.v1 + coeffs.b2 * self.v2;</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">            self.v2 = self.v1;</span>
<span class="line" id="L183">            self.v1 = w;</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">            <span class="tok-kw">return</span> y;</span>
<span class="line" id="L186">        }</span>
<span class="line" id="L187">    };</span>
<span class="line" id="L188">}</span>
<span class="line" id="L189"></span>
<span class="line" id="L190"><span class="tok-comment">/// The transposed direct form II biquad realization.</span></span>
<span class="line" id="L191"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">TransposedDirectFormII</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L192">    <span class="tok-kw">comptime</span> assertFloat(T);</span>
<span class="line" id="L193"></span>
<span class="line" id="L194">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L195">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L196"></span>
<span class="line" id="L197">        s1: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L198">        s2: T = <span class="tok-number">0.0</span>,</span>
<span class="line" id="L199"></span>
<span class="line" id="L200">        <span class="tok-comment">/// Filters a value through the section.</span></span>
<span class="line" id="L201">        <span class="tok-kw">fn</span> <span class="tok-fn">filter</span>(self: *Self, x: T, coeffs: *<span class="tok-kw">const</span> Coefficients(T)) T {</span>
<span class="line" id="L202">            <span class="tok-kw">const</span> y = self.s1 + coeffs.b0 * x;</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">            self.s1 = self.s2 + coeffs.b1 * x - coeffs.a1 * y;</span>
<span class="line" id="L205">            self.s2 = coeffs.b2 * x - coeffs.a2 * y;</span>
<span class="line" id="L206"></span>
<span class="line" id="L207">            <span class="tok-kw">return</span> y;</span>
<span class="line" id="L208">        }</span>
<span class="line" id="L209">    };</span>
<span class="line" id="L210">}</span>
<span class="line" id="L211"></span>
<span class="line" id="L212"><span class="tok-comment">/// Produces a compile error if `T` is not a float.</span></span>
<span class="line" id="L213"><span class="tok-kw">fn</span> <span class="tok-fn">assertFloat</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L214">    <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(T) != .Float) {</span>
<span class="line" id="L215">        <span class="tok-builtin">@compileError</span>(fmt.comptimePrint(</span>
<span class="line" id="L216">            <span class="tok-str">&quot;type `{}` is not a float&quot;</span>,</span>
<span class="line" id="L217">            .{<span class="tok-builtin">@typeName</span>(T)},</span>
<span class="line" id="L218">        ));</span>
<span class="line" id="L219">    }</span>
<span class="line" id="L220">}</span>
<span class="line" id="L221"></span>
</code></pre></body>
</html>